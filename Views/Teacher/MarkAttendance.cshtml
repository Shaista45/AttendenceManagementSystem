@model AttendenceManagementSystem.Controllers.TeacherController.MarkAttendanceViewModel
@{
    ViewData["Title"] = "Mark Attendance";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-edit me-2"></i>Mark Attendance
        </h1>
        <div class="alert alert-info mb-0 py-2">
            <i class="fas fa-info-circle me-2"></i>
            Attendance can be modified within 2 days
        </div>
    </div>

    <!-- Selection Form -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 bg-primary text-white">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-filter me-2"></i>Select Session, Section & Course
            </h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="MarkAttendance" id="filterForm">
                <div class="row">
                    <!-- Session/Batch Selection -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar-alt me-1"></i>Session (Batch) *
                        </label>
                        <select name="batchId" asp-items="@(ViewData["Batches"] as SelectList)"
                                class="form-select" onchange="this.form.submit()" required>
                            <option value="">-- Select Session --</option>
                        </select>
                    </div>

                    <!-- Section Selection -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-users me-1"></i>Section *
                        </label>
                        <select name="sectionId" asp-items="@(ViewData["Sections"] as SelectList)"
                                class="form-select" onchange="this.form.submit()" required>
                            <option value="">-- Select Section --</option>
                        </select>
                    </div>

                    <!-- Course Selection -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-book me-1"></i>Course *
                        </label>
                        <select name="courseId" asp-items="@(ViewData["Courses"] as SelectList)"
                                class="form-select" onchange="this.form.submit()" required>
                            <option value="">-- Select Course --</option>
                        </select>
                    </div>

                    <!-- Date Selection -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar me-1"></i>Date *
                        </label>
                        <input type="date" name="date" value="@Model.Date.ToString("yyyy-MM-dd")" 
                               class="form-control" onchange="this.form.submit()" 
                               max="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance Form -->
    @if (Model.Students.Any())
    {
        <div class="card shadow">
            <div class="card-header py-3 bg-success text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-check-circle me-2"></i>
                    Mark Attendance - @Model.Students.Count Students
                </h6>
            </div>
            <div class="card-body">
                <form method="post" asp-action="MarkAttendance">
                    <input type="hidden" asp-for="BatchId" />
                    <input type="hidden" asp-for="SectionId" />
                    <input type="hidden" asp-for="CourseId" />
                    <input type="hidden" asp-for="Date" />

                    <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <button type="button" class="btn btn-sm btn-success me-2 mb-2" onclick="markAll('0')">
                                <i class="fas fa-check me-1"></i>Mark All Present (Ctrl+P)
                            </button>
                            <button type="button" class="btn btn-sm btn-danger me-2 mb-2" onclick="markAll('1')">
                                <i class="fas fa-times me-1"></i>Mark All Absent (Ctrl+Shift+A)
                            </button>
                            <button type="button" class="btn btn-sm btn-warning mb-2" onclick="markAll('2')">
                                <i class="fas fa-clock me-1"></i>Mark All Late (Ctrl+L)
                            </button>
                        <div id="attendanceStats" class="mt-2 mt-md-0">
                            <span class="badge bg-success me-1">
                                <i class="fas fa-check me-1"></i>Present: <span id="presentCount">0</span>
                            </span>
                            <span class="badge bg-danger me-1">
                                <i class="fas fa-times me-1"></i>Absent: <span id="absentCount">0</span>
                            </span>
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-clock me-1"></i>Late: <span id="lateCount">0</span>
                            </span>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="8%">Roll No</th>
                                    <th width="25%">Student Name</th>
                                    <th width="12%">Batch</th>
                                    <th width="12%">Section</th>
                                    <th width="25%">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Students.Count; i++)
                                {
                                    <tr>
                                        <input type="hidden" asp-for="@Model.Students[i].StudentId" />
                                        <input type="hidden" asp-for="@Model.Students[i].RollNumber" />
                                        <input type="hidden" asp-for="@Model.Students[i].FullName" />
                                        <input type="hidden" asp-for="@Model.Students[i].Batch" />
                                        <input type="hidden" asp-for="@Model.Students[i].Section" />

                                        <td>
                                            <strong>@Model.Students[i].RollNumber</strong>
                                        </td>
                                        <td>@Model.Students[i].FullName</td>
                                        <td>@Model.Students[i].Batch</td>
                                        <td>@Model.Students[i].Section</td>
                                        <td>
                                            <select asp-for="@Model.Students[i].Status" class="form-select form-select-sm attendance-select"
                                                    disabled="@(!Model.CanEdit)">
                                                <option value="0" class="text-success">✓ Present</option>
                                                <option value="1" class="text-danger">✗ Absent</option>
                                                <option value="2" class="text-warning">⏰ Late</option>
                                            </select>
                                        </td>
                                        
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (Model.CanEdit)
                    {
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Save Attendance
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="fas fa-lock me-2"></i>
                            This attendance record is locked and cannot be modified.
                        </div>
                    }
                </form>
            </div>
        </div>
    }
    else if (Model.CourseId > 0)
    {
        <div class="card shadow">
            <div class="card-body text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No students found for the selected criteria</h5>
                <p class="text-muted">Please check if students are enrolled in this course and section.</p>
            </div>
        </div>
    }
    else
    {
        <div class="card shadow">
            <div class="card-body text-center py-5">
                <i class="fas fa-hand-pointer fa-3x text-primary mb-3"></i>
                <h5 class="text-primary">Please select Session, Section, and Course</h5>
                <p class="text-muted">Use the dropdowns above to filter and mark attendance.</p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function setStatus(index, status) {
            // Set the status for a specific student
            $('select[name="Students[' + index + '].Status"]').val(status);
            updateSelectColor($('select[name="Students[' + index + '].Status"]')[0]);
            updateStats();
        }

        function markAll(status) {
            // Update all attendance select dropdowns
            $('.attendance-select').val(status);
            
            // Update colors for all selects
            $('.attendance-select').each(function() {
                updateSelectColor(this);
            });

            // Update statistics
            updateStats();

            // Show confirmation toast
            let statusText = status == '0' ? 'Present' : (status == '1' ? 'Absent' : 'Late');
            let icon = status == '0' ? 'check-circle' : (status == '1' ? 'times-circle' : 'clock');
            let bgClass = status == '0' ? 'bg-success' : (status == '1' ? 'bg-danger' : 'bg-warning');
            
            // Create toast notification
            let toast = `<div class="toast-notification ${bgClass} text-white" style="position: fixed; top: 80px; right: 20px; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999; animation: slideIn 0.3s ease-out;">
                <i class="fas fa-${icon} me-2"></i>All students marked as ${statusText}
            </div>`;
            
            $('body').append(toast);
            setTimeout(function() {
                $('.toast-notification').fadeOut(300, function() { $(this).remove(); });
            }, 2000);
        }

        function updateStats() {
            var presentCount = $('.attendance-select option[value="0"]:selected').length;
            var absentCount = $('.attendance-select option[value="1"]:selected').length;
            var lateCount = $('.attendance-select option[value="2"]:selected').length;
            
            $('#presentCount').text(presentCount);
            $('#absentCount').text(absentCount);
            $('#lateCount').text(lateCount);
        }

        // Style select options based on value
        $('.attendance-select').each(function() {
            updateSelectColor(this);
        }).on('change', function() {
            updateSelectColor(this);
            updateStats();
        });

        function updateSelectColor(selectElement) {
            var value = $(selectElement).val();
            $(selectElement).removeClass('bg-success bg-danger bg-warning text-white text-dark');
            if (value == '0') {
                $(selectElement).addClass('bg-success text-white');
            } else if (value == '1') {
                $(selectElement).addClass('bg-danger text-white');
            } else if (value == '2') {
                $(selectElement).addClass('bg-warning text-dark');
            }
        }

        // Initialize stats on page load
        $(document).ready(function() {
            updateStats();
        });

        // Add keyboard shortcuts
        $(document).on('keydown', function(e) {
            // Ctrl+P for Present
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                markAll('0');
            }
            // Ctrl+A for Absent (but not Ctrl+A for Select All)
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                markAll('1');
            }
            // Ctrl+L for Late
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                markAll('2');
            }
        });

        // Confirm before submitting
        $('form[method="post"]').on('submit', function(e) {
            var presentCount = $('.attendance-select option[value="0"]:selected').length;
            var absentCount = $('.attendance-select option[value="1"]:selected').length;
            var lateCount = $('.attendance-select option[value="2"]:selected').length;
            var totalCount = presentCount + absentCount + lateCount;
            
            if (!confirm(`Are you sure you want to save attendance for ${totalCount} students?\n\nPresent: ${presentCount}\nAbsent: ${absentCount}\nLate: ${lateCount}`)) {
                e.preventDefault();
                return false;
            }
        });

        // Add animation for toast
        $('<style>')
            .text(`
                @@keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `)
            .appendTo('head');
    </script>
}