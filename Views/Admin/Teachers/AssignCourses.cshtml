@model AttendenceManagementSystem.ViewModels.AssignCoursesViewModel

@{
    ViewData["Title"] = "Assign Courses";
}

<div class="container-fluid px-4 mt-4">
    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h1 class="h3 mb-0 fw-bold text-primary">
                <i class="fas fa-book-reader me-2"></i>Course Assignment Manager
            </h1>
            <p class="text-muted small mb-0">Assign courses and manage teaching schedule</p>
        </div>
        <a asp-action="TeacherDetails" asp-route-id="@Model.TeacherId" class="btn btn-outline-secondary btn-sm shadow-sm">
            <i class="fas fa-arrow-left me-2"></i>Back to Profile
        </a>
    </div>

    <!-- Teacher Info Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100 border-start border-4 border-success shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col me-2">
                            <div class="text-uppercase text-success fw-bold x-small mb-1">Teacher Name</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@Model.TeacherName</div>
                        </div>
                        <div class="col-auto">
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                                <i class="fas fa-chalkboard-teacher fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 border-start border-4 border-warning shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col me-2">
                            <div class="text-uppercase text-warning text-dark fw-bold x-small mb-1">Department</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@Model.DepartmentName</div>
                        </div>
                        <div class="col-auto">
                            <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning text-dark">
                                <i class="fas fa-building fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Assignments -->
    @if (Model.ExistingAssignments.Any())
    {
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3 border-bottom">
                <h6 class="m-0 fw-bold text-info">
                    <i class="fas fa-list-check me-2"></i>Current Course Assignments (@Model.ExistingAssignments.Count)
                </h6>
            </div>
            <div class="card-body bg-light bg-opacity-50 p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 bg-white">
                        <thead class="table-light">
                            <tr>
                                <th class="fw-bold small">Course</th>
                                <th class="fw-bold small">Batch</th>
                                <th class="fw-bold small">Section</th>
                                <th class="fw-bold small">Day</th>
                                <th class="fw-bold small">Time Slot</th>
                                <th class="fw-bold small text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var assignment in Model.ExistingAssignments)
                            {
                                <tr>
                                    <td class="fw-bold text-primary small">@assignment.CourseName</td>
                                    <td class="small">@assignment.BatchName</td>
                                    <td class="small">@assignment.SectionName</td>
                                    <td>
                                        <span class="badge bg-primary">@assignment.DayOfWeek</span>
                                    </td>
                                    <td class="small text-muted">@assignment.TimeSlot</td>
                                    <td class="text-center">
                                        <form asp-action="RemoveAssignment" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="timetableId" value="@assignment.TimetableId" />
                                            <input type="hidden" name="teacherId" value="@Model.TeacherId" />
                                            <button type="submit" class="btn btn-sm btn-danger shadow-sm" 
                                                    onclick="return confirm('Remove this course assignment?');">
                                                <i class="fas fa-trash me-1"></i>Remove
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Add New Assignments -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-success">
                <i class="fas fa-plus-circle me-2"></i>Add New Course Assignments
            </h6>
            <button type="button" class="btn btn-sm btn-success shadow-sm" onclick="addAssignmentRow()">
                <i class="fas fa-plus me-1"></i>Add Row
            </button>
        </div>
        <div class="card-body bg-light bg-opacity-50">
            <form asp-action="AssignCourses" method="post" id="assignForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="teacherId" value="@Model.TeacherId" />

                <div id="assignmentsContainer" class="mb-3">
                    <!-- Assignment rows will be added here dynamically -->
                </div>

                <div class="alert alert-info border-0 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-info bg-opacity-10 p-2 rounded-circle text-info me-3">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="small">
                            <strong>Instructions:</strong> Click "Add Row" to create new course assignments. Fill in all required fields and click "Save Assignments" when done.
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                    <a asp-action="TeacherDetails" asp-route-id="@Model.TeacherId" class="btn btn-outline-secondary shadow-sm">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary shadow-sm px-4">
                        <i class="fas fa-save me-2"></i>Save All Assignments
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let assignmentIndex = 0;
        
        // Build dropdown options from server-side data
        const courses = @Html.Raw(Json.Serialize(((SelectList)ViewBag.Courses).Select(c => new { value = c.Value, text = c.Text })));
        const batches = @Html.Raw(Json.Serialize(((SelectList)ViewBag.Batches).Select(b => new { value = b.Value, text = b.Text })));
        const sections = @Html.Raw(Json.Serialize(((SelectList)ViewBag.Sections).Select(s => new { value = s.Value, text = s.Text })));

        function buildOptions(items) {
            return items.map(item => `<option value="${item.value}">${item.text}</option>`).join('');
        }

        function addAssignmentRow() {
            const container = document.getElementById('assignmentsContainer');
            const row = document.createElement('div');
            row.className = 'card border-0 shadow-sm mb-3 assignment-row';
            row.innerHTML = `
                <div class="card-body bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 text-primary fw-bold">
                            <i class="fas fa-calendar-plus me-2"></i>Assignment #${assignmentIndex + 1}
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAssignmentRow(this)">
                            <i class="fas fa-times me-1"></i>Remove
                        </button>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Course <span class="text-danger">*</span></label>
                            <select name="assignments[${assignmentIndex}].CourseId" class="form-select form-select-sm shadow-sm" required>
                                <option value="">-- Select Course --</option>
                                ${buildOptions(courses)}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Batch <span class="text-danger">*</span></label>
                            <select name="assignments[${assignmentIndex}].BatchId" class="form-select form-select-sm shadow-sm" required>
                                <option value="">-- Select --</option>
                                ${buildOptions(batches)}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Section <span class="text-danger">*</span></label>
                            <select name="assignments[${assignmentIndex}].SectionId" class="form-select form-select-sm shadow-sm" required>
                                <option value="">-- Select --</option>
                                ${buildOptions(sections)}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Day of Week <span class="text-danger">*</span></label>
                            <select name="assignments[${assignmentIndex}].DayOfWeek" class="form-select form-select-sm shadow-sm" required>
                                <option value="">-- Select Day --</option>
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Start Time <span class="text-danger">*</span></label>
                            <input type="time" name="assignments[${assignmentIndex}].StartTime" class="form-control form-control-sm shadow-sm" required />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">End Time <span class="text-danger">*</span></label>
                            <input type="time" name="assignments[${assignmentIndex}].EndTime" class="form-control form-control-sm shadow-sm" required />
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm w-100 shadow-sm" onclick="removeAssignmentRow(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(row);
            assignmentIndex++;
        }

        function removeAssignmentRow(button) {
            const row = button.closest('.assignment-row');
            row.style.opacity = '0';
            row.style.transform = 'scale(0.95)';
            row.style.transition = 'all 0.3s ease';
            setTimeout(() => row.remove(), 300);
        }

        // Add first row on page load
        document.addEventListener('DOMContentLoaded', function() {
            addAssignmentRow();
        });

        // Form validation
        document.getElementById('assignForm').addEventListener('submit', function(e) {
            const rows = document.querySelectorAll('.assignment-row');
            if (rows.length === 0) {
                e.preventDefault();
                alert('Please add at least one course assignment.');
                return false;
            }
        });
    </script>
}

