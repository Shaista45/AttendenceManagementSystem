@model AttendenceManagementSystem.Models.Student
@{
    ViewData["Title"] = "Edit Student";
}

<div class="container-fluid py-4">
    <!-- Alert Container -->
    <div id="formAlert"></div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Edit Student Information
                    </h4>
                </div>
                <div class="card-body">
                    <form id="editStudentForm" method="post" asp-action="EditStudent">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="UserId" />
                        <input type="hidden" asp-for="RollNumber" />
                        <input type="hidden" asp-for="CreatedAt" />
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <h5 class="text-primary mb-3">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="FullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input asp-for="FullName" class="form-control" />
                                <span asp-validation-for="FullName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input asp-for="Email" class="form-control" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="PhoneNumber" class="form-label">Phone Number</label>
                                <input asp-for="PhoneNumber" class="form-control" />
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Roll Number</label>
                                <input type="text" class="form-control" value="@Model.RollNumber" disabled />
                                <small class="text-muted">Roll number cannot be changed</small>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <h5 class="text-success mb-3">
                            <i class="fas fa-graduation-cap me-2"></i>Academic Information
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label asp-for="DepartmentId" class="form-label">Department <span class="text-danger">*</span></label>
                                <select asp-for="DepartmentId" class="form-select" id="departmentSelect" asp-items="@(ViewData["Departments"] as SelectList)">
                                    <option value="">-- Select Department --</option>
                                </select>
                                <span asp-validation-for="DepartmentId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="BatchId" class="form-label">Batch/Session <span class="text-danger">*</span></label>
                                <select asp-for="BatchId" class="form-select" id="batchSelect" asp-items="@(ViewData["Batches"] as SelectList)">
                                    <option value="">-- Select Batch/Session --</option>
                                </select>
                                <span asp-validation-for="BatchId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="SectionId" class="form-label">Section <span class="text-danger">*</span></label>
                                <select asp-for="SectionId" class="form-select" id="sectionSelect" asp-items="@(ViewData["Sections"] as SelectList)">
                                    <option value="">-- Select Section --</option>
                                </select>
                                <span asp-validation-for="SectionId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Current Information:</strong> 
                            @Model.Department?.Name (@Model.Batch?.Year - @Model.Section?.Name) | Registered: @Model.CreatedAt.ToString("MMM dd, yyyy")
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Students" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Students
                            </a>
                            <button type="submit" id="saveBtn" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Student
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            // AJAX form submission
            $('#editStudentForm').on('submit', function(e) {
                e.preventDefault();
                
                var form = $(this);
                var btn = $('#saveBtn');
                var originalText = btn.html();
                
                // Disable button and change text
                btn.prop('disabled', true).text('Updating...');
                
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            $('#formAlert').html(
                                '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                '<i class="fas fa-check-circle me-2"></i>' + response.message +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                                '</div>'
                            );
                            
                            // Scroll to top to show alert
                            window.scrollTo(0, 0);
                            
                            // Auto-dismiss after 5 seconds and redirect
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Students", "Admin")';
                            }, 2000);
                        } else {
                            // Show error message
                            var errorHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                '<i class="fas fa-exclamation-triangle me-2"></i><strong>Error:</strong> ' + response.message;
                            
                            if (response.errors && response.errors.length > 0) {
                                errorHtml += '<ul class="mb-0 mt-2">';
                                response.errors.forEach(function(error) {
                                    errorHtml += '<li>' + error + '</li>';
                                });
                                errorHtml += '</ul>';
                            }
                            
                            errorHtml += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                            $('#formAlert').html(errorHtml);
                            
                            // Scroll to top to show alert
                            window.scrollTo(0, 0);
                            
                            // Re-enable button
                            btn.prop('disabled', false).html(originalText);
                            
                            // Auto-dismiss after 10 seconds
                            setTimeout(function() {
                                $('.alert').alert('close');
                            }, 10000);
                        }
                    },
                    error: function() {
                        $('#formAlert').html(
                            '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                            '<i class="fas fa-exclamation-triangle me-2"></i>An unexpected error occurred. Please try again.' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                            '</div>'
                        );
                        window.scrollTo(0, 0);
                        btn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // Load batches when department is selected
            $('#departmentSelect').on('change', function() {
                var departmentId = $(this).val();
                var batchSelect = $('#batchSelect');
                var sectionSelect = $('#sectionSelect');
                
                // Clear batch and section dropdowns
                batchSelect.html('<option value="">-- Select Batch/Session --</option>');
                sectionSelect.html('<option value="">-- Select Section --</option>');
                
                if (departmentId) {
                    $.ajax({
                        url: '@Url.Action("GetBatchesByDepartment", "Admin")',
                        type: 'GET',
                        data: { departmentId: departmentId },
                        success: function(batches) {
                            $.each(batches, function(i, batch) {
                                batchSelect.append($('<option></option>').val(batch.id).html(batch.year));
                            });
                            // Restore selected batch if exists
                            var selectedBatch = '@Model.BatchId';
                            if (selectedBatch) {
                                batchSelect.val(selectedBatch).trigger('change');
                            }
                        },
                        error: function() {
                            alert('Error loading batches. Please try again.');
                        }
                    });
                }
            });

            // Load sections when batch is selected
            $('#batchSelect').on('change', function() {
                var batchId = $(this).val();
                var sectionSelect = $('#sectionSelect');
                
                // Clear section dropdown
                sectionSelect.html('<option value="">-- Select Section --</option>');
                
                if (batchId) {
                    $.ajax({
                        url: '@Url.Action("GetSectionsByBatch", "Admin")',
                        type: 'GET',
                        data: { batchId: batchId },
                        success: function(sections) {
                            $.each(sections, function(i, section) {
                                sectionSelect.append($('<option></option>').val(section.id).html(section.name));
                            });
                            // Restore selected section if exists
                            var selectedSection = '@Model.SectionId';
                            if (selectedSection) {
                                sectionSelect.val(selectedSection);
                            }
                        },
                        error: function() {
                            alert('Error loading sections. Please try again.');
                        }
                    });
                }
            });

            // Trigger department change to load initial data
            if ($('#departmentSelect').val()) {
                $('#departmentSelect').trigger('change');
            }
        });
    </script>
}
