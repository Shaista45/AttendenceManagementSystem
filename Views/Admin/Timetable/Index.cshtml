@model AttendenceManagementSystem.ViewModels.TimetableViewModel

@{
    ViewData["Title"] = "Manage Timetable";
    var days = new[] { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, DayOfWeek.Saturday };
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-alt me-2"></i>Manage Timetable
        </h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Select Department & Section</h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="ManageTimetable">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <select name="departmentId" class="form-control" asp-items="ViewBag.Departments" onchange="this.form.submit()">
                            <option value="">-- Select Department --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Batch / Semester</label>
                        <select name="batchId" class="form-control" asp-items="ViewBag.Batches" onchange="this.form.submit()">
                            <option value="">-- Select Batch --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Section</label>
                        <select name="sectionId" class="form-control" asp-items="ViewBag.Sections" onchange="this.form.submit()">
                            <option value="">-- Select Section --</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i> Load Timetable
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model != null && Model.TimetableEntries != null)
    {
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-success">Add Class to Schedule</h6>
            </div>
            <div class="card-body">
                <form asp-action="AddTimetableEntry" method="post" class="row g-3">
                    <input type="hidden" name="departmentId" value="@Model.DepartmentId" />
                    <input type="hidden" name="batchId" value="@Model.BatchId" />
                    <input type="hidden" name="sectionId" value="@Model.SectionId" />

                    <div class="col-md-3">
                        <label class="form-label">Day</label>
                        <select name="dayOfWeek" class="form-control" required>
                            @foreach (var day in days)
                            {
                                <option value="@day">@day</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Course</label>
                        <select name="courseId" class="form-control" asp-items="ViewBag.Courses" required>
                            <option value="">-- Select Course --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Teacher</label>
                        <select name="teacherId" class="form-control" asp-items="ViewBag.Teachers" required>
                            <option value="">-- Select Teacher --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Time</label>
                        <div class="input-group">
                            <input type="time" name="startTime" class="form-control" required />
                            <span class="input-group-text">to</span>
                            <input type="time" name="endTime" class="form-control" required />
                        </div>
                    </div>
                    <div class="col-12 text-end mt-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i> Add Class
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row">
            @foreach (var day in days)
            {
                var classes = Model.TimetableEntries.Where(t => t.DayOfWeek == day).OrderBy(t => t.StartTime).ToList();
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm border-left-primary">
                        <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                            <h6 class="font-weight-bold text-primary mb-0">@day</h6>
                            <span class="badge bg-primary rounded-pill">@classes.Count</span>
                        </div>
                        <div class="card-body p-0">
                            @if (classes.Any())
                            {
                                <ul class="list-group list-group-flush">
                                    @foreach (var item in classes)
                                    {
                                        <li class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1 font-weight-bold">@item.Course?.Code</h6>
                                                <small class="text-muted">
                                                    @DateTime.Today.Add(item.StartTime).ToString("hh:mm tt") - 
                                                    @DateTime.Today.Add(item.EndTime).ToString("hh:mm tt")
                                                </small>
                                            </div>
                                            <p class="mb-1 text-sm">@item.Course?.Title</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-info"><i class="fas fa-user-tie me-1"></i>@item.Teacher?.FullName</small>
                                                <form asp-action="DeleteTimetableEntry" method="post" onsubmit="return confirm('Are you sure you want to remove this class?');">
                                                    <input type="hidden" name="id" value="@item.Id" />
                                                    <input type="hidden" name="departmentId" value="@Model.DepartmentId" />
                                                    <input type="hidden" name="batchId" value="@Model.BatchId" />
                                                    <input type="hidden" name="sectionId" value="@Model.SectionId" />
                                                    <button type="submit" class="btn btn-danger btn-sm py-0 px-2" title="Remove">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <div class="text-center py-4 text-muted">
                                    <p class="small mb-0">No classes</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>Please select Department, Batch, and Section to view or manage the timetable.
        </div>
    }
</div>