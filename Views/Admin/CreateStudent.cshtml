@model AttendenceManagementSystem.Models.Student
@{
    ViewData["Title"] = "Add New Student";
}

<div class="container-fluid px-4 mt-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h1 class="h3 mb-0 fw-bold text-primary">
                <i class="fas fa-user-plus me-2"></i>Register Student
            </h1>
            <p class="text-muted small mb-0">Create a new student record and assign initial enrollment</p>
        </div>
        <a class="btn btn-outline-secondary btn-sm shadow-sm bg-white" asp-action="Students">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <h6 class="m-0 fw-bold">
                        <i class="fas fa-id-card me-2"></i>Student Details
                    </h6>
                </div>
                <div class="card-body p-4 bg-light bg-opacity-10">
                    <form asp-action="CreateStudent" method="post" id="studentForm">
                        @Html.AntiForgeryToken()
                        
                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger shadow-sm border-left-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i> Please correct the errors below.
                            </div>
                        }

                        <h6 class="text-uppercase text-muted fw-bold x-small mb-3 border-bottom pb-2">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label asp-for="RollNumber" class="form-label fw-bold small text-dark">Roll Number <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-hashtag text-muted"></i></span>
                                    <input asp-for="RollNumber" class="form-control border-start-0 ps-0 shadow-sm" placeholder="e.g. 2023-CS-101" />
                                </div>
                                <span asp-validation-for="RollNumber" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="FullName" class="form-label fw-bold small text-dark">Full Name <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-font text-muted"></i></span>
                                    <input asp-for="FullName" class="form-control border-start-0 ps-0 shadow-sm" placeholder="e.g. John Doe" />
                                </div>
                                <span asp-validation-for="FullName" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Email" class="form-label fw-bold small text-dark">Email Address <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-envelope text-muted"></i></span>
                                    <input asp-for="Email" type="email" class="form-control border-start-0 ps-0 shadow-sm" placeholder="student@university.edu" />
                                </div>
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="PhoneNumber" class="form-label fw-bold small text-dark">Phone Number</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-phone text-muted"></i></span>
                                    <input asp-for="PhoneNumber" class="form-control border-start-0 ps-0 shadow-sm" placeholder="+92 300 1234567" />
                                </div>
                                <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                            </div>
                        </div>

                        <h6 class="text-uppercase text-muted fw-bold x-small mb-3 border-bottom pb-2 mt-4">
                            <i class="fas fa-university me-2"></i>Academic Assignment
                        </h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label asp-for="DepartmentId" class="form-label fw-bold small text-dark">Department <span class="text-danger">*</span></label>
                                <select asp-for="DepartmentId" class="form-select shadow-sm" asp-items="ViewBag.DepartmentId" id="departmentSelect">
                                    <option value="">-- Select Department --</option>
                                </select>
                                <span asp-validation-for="DepartmentId" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="BatchId" class="form-label fw-bold small text-dark">Batch (Year) <span class="text-danger">*</span></label>
                                <select asp-for="BatchId" class="form-select shadow-sm" id="batchSelect" disabled>
                                    <option value="">-- Select Department First --</option>
                                </select>
                                <span asp-validation-for="BatchId" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="SectionId" class="form-label fw-bold small text-dark">Section <span class="text-danger">*</span></label>
                                <select asp-for="SectionId" class="form-select shadow-sm" id="sectionSelect" disabled>
                                    <option value="">-- Select Batch First --</option>
                                </select>
                                <span asp-validation-for="SectionId" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-3 pt-3 border-top">
                            <a class="btn btn-light px-4 border" asp-action="Students">Cancel</a>
                            <button type="submit" class="btn btn-primary px-5 shadow-sm" id="saveStudentBtn">
                                <i class="fas fa-save me-2"></i>Create Record
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Function to handle empty states and disabling
            function resetDropdown(selector, defaultText) {
                $(selector).html('<option value="">' + defaultText + '</option>').prop('disabled', true);
            }

            // Load batches when department is selected
            $('#departmentSelect').on('change', function() {
                var departmentId = $(this).val();
                
                resetDropdown('#batchSelect', '-- Select Batch --');
                resetDropdown('#sectionSelect', '-- Select Batch First --');
                
                if (departmentId) {
                    // Show loading state
                    $('#batchSelect').html('<option>Loading...</option>');
                    
                    $.ajax({
                        url: '@Url.Action("GetBatchesByDepartment", "Admin")',
                        type: 'GET',
                        data: { departmentId: departmentId },
                        success: function(batches) {
                            var $batchSelect = $('#batchSelect');
                            $batchSelect.empty().append('<option value="">-- Select Batch --</option>');
                            $.each(batches, function(i, batch) {
                                $batchSelect.append($('<option></option>').val(batch.id).html(batch.year));
                            });
                            $batchSelect.prop('disabled', false);
                        },
                        error: function() {
                            resetDropdown('#batchSelect', 'Error loading batches');
                        }
                    });
                }
            });

            // Load sections when batch is selected
            $('#batchSelect').on('change', function() {
                var batchId = $(this).val();
                
                resetDropdown('#sectionSelect', '-- Select Section --');
                
                if (batchId) {
                    $('#sectionSelect').html('<option>Loading...</option>');
                    
                    $.ajax({
                        url: '@Url.Action("GetSectionsByBatch", "Admin")',
                        type: 'GET',
                        data: { batchId: batchId },
                        success: function(sections) {
                            var $secSelect = $('#sectionSelect');
                            $secSelect.empty().append('<option value="">-- Select Section --</option>');
                            $.each(sections, function(i, section) {
                                $secSelect.append($('<option></option>').val(section.id).html(section.name));
                            });
                            $secSelect.prop('disabled', false);
                        },
                        error: function() {
                             resetDropdown('#sectionSelect', 'Error loading sections');
                        }
                    });
                }
            });

            // Form submission visual feedback
            $('#studentForm').on('submit', function(e) {
                if ($(this).valid()) {
                    var $btn = $('#saveStudentBtn');
                    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...');
                }
            });
        });
    </script>
    <style>
        .input-group-text { border-color: #d1d3e2; }
        .form-control:focus, .form-select:focus { border-color: var(--uet-royal-blue); box-shadow: 0 0 0 0.2rem rgba(0,0,102,0.15); }
        .x-small { font-size: 0.75rem; letter-spacing: 0.05em; }
    </style>
}